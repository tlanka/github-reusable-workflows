# action.yml
name: 'Custom Github Action to Update Deployment YAML files'

on:
  workflow_call:
    inputs:
      image_tag:
        description: Image tag of the docker image
        required: true
        type: string
        default: 'latest'
      git_user:
        description: username to access github repo
        required: true
        type: string
      git_password:
        description: Personal Access Token for k8s deployment files repo
        required: true
        type: string
      app_name:
        description: App name to be update
        required: true
        type: string
      environment:
        description: Environment to be update
        required: true
        type: string
      DOCKER_USERNAME:
        description: Docker user name
        required: true
        type: string
      DOCKER_PASSWORD:
        description: Docker password
        required: true
        type: string
      jenkins_user:
        description: Jenkins user
        required: true
        type: string
      jenkins_password:
        description: Jenkins password
        required: true
        type: string
        
jobs:
  build-and-push-docker-image:
    # run only when code is compiling and tests are passing
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.17.6]

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install Dependencies
        run: npm install

      - name: Run list and prettier and elm-format
        run: |
          npm run lint
          npx prettier --check '{config,server,src/static}/**/*.{css,html,js,json,ts}'
          npx elm-format src --validate
    #  - name: Run Build
    #    run: npm run build

    #  - name: Login to DockerHub
    #    uses: docker/login-action@v1
    #    with:
    #      username: ${inputs.DOCKER_USERNAME}
    #      password: ${inputs.DOCKER_PASSWORD}

    #  - name: Build image and push to DockerHub
    #    id: docker_build_push
    #    uses: docker/build-push-action@v2
    #    with:
      #     # relative path to the place where source code with Dockerfile is located
    #      context: .
    #      push: true
      #     # Note: tags has to be all lower-case
    #      tags: pics/ui:${inputs.image_tag}


      - name: Trigger your-awesome-job-name job
        run: |
          curl https://jenkins.avettatech.com/job/${inputs.environment}-deploy-generic/buildWithParameters \
             --user avettajenkins:${inputs.jenkins_password} \
             --data ContainerName=${inputs.app_name} --data DockerHubTag=${inputs.image_tag}
